---
title: "Sampling notes"
output: html_document
# output: bookdown::html_document2
---


- area-based sampling allocation (@doherty2019phma, see pg 10)
- Allocation definitions moved to `prep-survey-allocations.R`


```{r}
library(dplyr)
library(ggplot2)

source('R/00-settings.R')
source('R/00-utils.R')

# Load the prepared allocations
hbll_allocations <- readRDS(here::here("data-generated", "hbll-allocations.rds"))

sp <- sp_to_hyphens("yelloweye rockfish")
bait_counts <- readRDS(file.path(synopsis_cache, "bait-counts.rds"))
sp_dat0 <- readRDS(file.path(synopsis_cache, paste0(sp, ".rds")))$survey_sets |>
  rename(survey_series_id = "survey_series_id.x") |>
  filter(survey_series_id %in% c(hbll_ssids, syn_ssids))
sp_dat <- filter(sp_dat0, survey_series_id %in% hbll_ssids)
strata0 <- readRDS(here::here("data-raw", "strata-lookup.rds"))

hbll_strata <- strata0 |> filter(survey_series_id %in% hbll_ssids)

# TODO: maybe get_strata function needs to include both rows of the grouping_code because sometimes the in-field codes are not converted to the fishing event grouping codes (even though they should be, this maybe should be flagged as a report to norm/malcolm/maria/jon
# NOTE: Future change: strata_depth_label will become strata_depth
strata_317_326 <- strata0 |> 
  filter(fe_grouping_code %in% c(317, 318, 319, 320, 321, 322, 323, 324, 325, 326)) |>
  mutate(grouping_code = fe_grouping_code) |>
  distinct(grouping_code, .keep_all = TRUE)
# Need to deal with this in the get_strata function
hbll_47_48 <- strata0 |> filter(survey_series_id == 39) |>
  select(survey_series_id, grouping_code, min_depth_m, max_depth_m, 
         depth_operator, fe_grouping_code, strata_depth) |>
  slice(1:2) |>
  mutate(grouping_code = case_when(min_depth_m == 40 ~ 47, 
                                      min_depth_m == 71 ~ 48,
                                      TRUE ~ NA_real_)) |>
  mutate(fe_grouping_code = grouping_code) |>
  mutate(grouping_desc = case_when(min_depth_m == 40 ~ "Inshore rockfish 2: 41 - 70 m",
                                   min_depth_m == 71 ~ "Inshore rockfish 2: 71 - 100 m",
                                   TRUE ~ NA_character_))

hbll_strata <- strata0 |> filter(survey_series_id %in% c(22, 36, 39, 40)) |>
  bind_rows(hbll_47_48, strata_317_326) |>
  distinct(grouping_code, .keep_all = TRUE)

syn_strata <- strata0 |> filter(survey_series_id %in% syn_ssids)

strata <- bind_rows(hbll_strata, syn_strata)

historical <- left_join(sp_dat0, strata, by = c("survey_series_id", "grouping_code"))

# Ok, turns out there are quite a few grouping codes that don't seem to match what they should be. I guess worth following up on so these get fixed.
historical |>
  XY_to_sf(x_col = "longitude", y_col = "latitude", crs_from = 4326) |>
  ggplot() +
  geom_sf(aes(colour = min_depth_m), size = 0.5) +
  scale_colour_viridis_c(direction = -1)

filter(historical, is.na(strata_depth)) |> distinct(survey_series_id, grouping_code, depth_m, grouping_spatial_id)
# FIXME: Deal with this later
# ----

historical |> filter(year == 2016 & survey_series_id == 36) |> distinct(grouping_code)
  select(survey_series_id, grouping_code, grouping_spatial_id) |>
  distinct()
  group_by(grouping_code) |>
  summarise(n = n())

# Using the survey data is not the way to work backwards to the historical allocations - I think we need to look at survey block tracking for this?
historical |> filter(year == 2021 & survey_series_id == 39) |>
  group_by(grouping_code) |>
  summarise(n = n())

```

Aborting mission on joining the survey data to the strata data. It is too complicated and the get_strata function needs to be reworked.

Instead --> just start with doing the resampling based on historical allocations as noted in the papers. Now I remember why I was trying to join them, I was going to check the outside strata allocations.


## HBLL Survey Allocations Summary

The HBLL survey allocations have been prepared in `prep-survey-allocations.R` and saved to `data-generated/hbll-allocations.rds`. 

```{r}
# Display summary of prepared allocations
knitr::kable(hbll_allocations, 
             caption = "HBLL survey allocations by survey series, PFMA, and depth strata")
```

## HBLL Inside Survey Allocation Reference

```{r}
# Create reference table for HBLL Inside survey sampling allocation
hbll_ins_allocation <- data.frame(
  Survey = c(rep("North", 4), rep("South", 16)),
  PFMA = as.character(c(12, 12, 13, 13, 14, 14, 15, 15, 16, 16, 17, 17, 18, 18, 19, 19, 28, 28, 29, 29)),
  Depth_Strata = c("40-70 m", "71-100 m", "40-70 m", "71-100 m", 
                   "40-70 m", "71-100 m", "40-70 m", "71-100 m", "40-70 m", "71-100 m", 
                   "40-70 m", "71-100 m", "40-70 m", "71-100 m", "40-70 m", "71-100 m", 
                   "40-70 m", "71-100 m", "40-70 m", "71-100 m"),
  Relative_Allocation = c(36.92, 16.92, 29.23, 16.92, 
                          7.14, 7.14, 11.43, 11.43, 10.00, 8.57, 8.57, 2.86, 
                          7.14, 4.29, 1.43, 1.43, 5.71, 4.29, 4.29, 4.29),
  Allocation_2021 = c(26, 12, 20, 12, 5, 5, 8, 8, 7, 6, 6, 2, 5, 3, 1, 1, 4, 3, 3, 3)
)

# Create formatted table
knitr::kable(hbll_ins_allocation, 
             col.names = c("Survey", "PFMA", "Depth Strata", "Relative Allocation (%)", "2021 Allocation"),
             digits = c(0, 0, 0, 2, 0),
             caption = "Sampling allocation for HBLL Inside surveys by Pacific Fishery Management Area (PFMA) and depth strata. The North survey covers PFMAs 12-13 while the South survey covers PFMAs 14-19, 28-29. Each survey allocates 70 sampling blocks across depth strata (40-70 m and 71-100 m) based on relative area coverage. Modified from Tables 1 and 2 in @williams2022hbll.")
```

## HBLL Outside Survey Allocation Reference

```{r}
# Create reference table of HBLL Outside survey sampling allocation from @doherty2019phma Table 2.7
hbll_out_allocation <- data.frame(
  Survey = c(rep("North", 12), rep("South", 12)),
  Area = c("5E", "5E", "5E", "5D", "5D", "5D", "5C", "5C", "5C", "5B", "5B", "5B",
           "5B", "5B", "5B", "5A4B", "5A4B", "5A4B", "3D", "3D", "3D", "3C", "3C", "3C"),
  Strata = c(1:12, 1:12),
  Depth_Strata = c("20-70", "71-150", "151-260", "20-70", "71-150", "151-260", 
                   "20-70", "71-150", "151-260", "20-70", "71-150", "151-260",
                   "20-70", "71-150", "151-260", "20-70", "71-150", "151-260", 
                   "20-70", "71-150", "151-260", "20-70", "71-150", "151-260"),
  Area_km2 = c(808, 1124, 1032, 1104, 1520, 584, 1276, 2604, 1716, 96, 216, 340,
                520, 1296, 496, 1132, 1832, 824, 1376, 1664, 528, 924, 704, 100),
  # Mean_CPUE = c(61, 205, 257, 9, 26, 13, 17, 40, 21, 120, 191, 136,
  #                28, 60, 61, 13, 57, 169, 18, 71, 71, 6, 5, 4),
  # Mean_SD = c(76, 153, 239, 17, 46, 21, 22, 51, 34, 194, 184, 179,
  #              28, 79, 105, 26, 81, 186, 34, 101, 105, 14, 11, 5),
  # Zero_Catch_Percent = c(10, 1, 15, 54, 39, 62, 28, 15, 46, 0, 0, 22,
  #                        28, 22, 54, 57, 27, 12, 48, 41, 37, 77, 71, 58),
  Historical_Allocation = c(6, 9, 9, 8, 13, 5, 9, 21, 13, 1, 2, 3,
                           4, 11, 5, 9, 16, 9, 11, 14, 6, 7, 6, 1),
  Area_Optimal = c(7, 9, 8, 9, 12, 5, 10, 21, 14, 1, 2, 3,
                    5, 11, 4, 10, 16, 7, 12, 15, 5, 8, 6, 1),
  Optimal_Allocation = c(7, 19, 27, 2, 8, 1, 3, 15, 6, 2, 4, 7,
                         2, 13, 7, 4, 19, 19, 6, 21, 7, 2, 1, 0)
)

# Create formatted table
knitr::kable(hbll_out_allocation, 
             col.names = c("Survey", "Area", "Strata", "Depth (m)", "Area (kmÂ²)", 
                          "Historical (%)", "Area (%)", "Optimal (%)"),
             digits = c(0, 0, 0, 0, 0, 0, 0, 0),
             caption = "Reference: Table 2.7 from @doherty2019phma.")
```

## LaTeX Table Version

```latex
\begin{table}[htbp]
\centering
\caption{Sampling allocation for HBLL Inside surveys by Pacific Fishery Management Area (PFMA) and depth strata. The North survey covers PFMAs 12-13 while the South survey covers PFMAs 14-19, 28-29. Each survey allocates 70 sampling blocks across depth strata (40-70 m and 71-100 m) based on relative area coverage. Data from \cite{williams2022hbll}.}
\label{tab:hbll-inside-allocation}
\begin{tabular}{llllr}
\toprule
Survey & PFMA & Depth Strata & Relative Allocation (\%) & 2021 Allocation \\
\midrule
North & 12 & 40-70 m & 36.92 & 26 \\
North & 12 & 71-100 m & 16.92 & 12 \\
North & 13 & 40-70 m & 29.23 & 20 \\
North & 13 & 71-100 m & 16.92 & 12 \\
\midrule
South & 14 & 40-70 m & 7.14 & 5 \\
South & 14 & 71-100 m & 7.14 & 5 \\
South & 15 & 40-70 m & 11.43 & 8 \\
South & 15 & 71-100 m & 11.43 & 8 \\
South & 16 & 40-70 m & 10.00 & 7 \\
South & 16 & 71-100 m & 8.57 & 6 \\
South & 17 & 40-70 m & 8.57 & 6 \\
South & 17 & 71-100 m & 2.86 & 2 \\
South & 18 & 40-70 m & 7.14 & 5 \\
South & 18 & 71-100 m & 4.29 & 3 \\
South & 19 & 40-70 m & 1.43 & 1 \\
South & 19 & 71-100 m & 1.43 & 1 \\
South & 28 & 40-70 m & 5.71 & 4 \\
South & 28 & 71-100 m & 4.29 & 3 \\
South & 29 & 40-70 m & 4.29 & 3 \\
South & 29 & 71-100 m & 4.29 & 3 \\
\bottomrule
\end{tabular}
\end{table}
```

## Markdown Table Version

| Survey | PFMA | Depth Strata | Relative Allocation (%) | 2021 Allocation |
|--------|------|--------------|------------------------|-----------------|
| North | 12 | 40-70 m | 36.92 | 26 |
| North | 12 | 71-100 m | 16.92 | 12 |
| North | 13 | 40-70 m | 29.23 | 20 |
| North | 13 | 71-100 m | 16.92 | 12 |
| South | 14 | 40-70 m | 7.14 | 5 |
| South | 14 | 71-100 m | 7.14 | 5 |
| South | 15 | 40-70 m | 11.43 | 8 |
| South | 15 | 71-100 m | 11.43 | 8 |
| South | 16 | 40-70 m | 10.00 | 7 |
| South | 16 | 71-100 m | 8.57 | 6 |
| South | 17 | 40-70 m | 8.57 | 6 |
| South | 17 | 71-100 m | 2.86 | 2 |
| South | 18 | 40-70 m | 7.14 | 5 |
| South | 18 | 71-100 m | 4.29 | 3 |
| South | 19 | 40-70 m | 1.43 | 1 |
| South | 19 | 71-100 m | 1.43 | 1 |
| South | 28 | 40-70 m | 5.71 | 4 |
| South | 28 | 71-100 m | 4.29 | 3 |
| South | 29 | 40-70 m | 4.29 | 3 |
| South | 29 | 71-100 m | 4.29 | 3 |

*Table: Sampling allocation for HBLL Inside surveys by Pacific Fishery Management Area (PFMA) and depth strata. The North survey covers PFMAs 12-13 while the South survey covers PFMAs 14-19, 28-29. Each survey allocates 70 sampling blocks across depth strata (40-70 m and 71-100 m) based on relative area coverage. Modified from Tables 1 and 2 in @williams2022hbll.*


